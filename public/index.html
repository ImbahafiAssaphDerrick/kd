<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link.active { font-weight: bold; }
        .card-header { background-color: #f8f9fa; }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="text-center mb-4">
            <i class="fas fa-book text-primary"></i> Library Management System
        </h1>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" href="#books" data-bs-toggle="tab">
                    <i class="fas fa-books"></i> Books
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#borrowers" data-bs-toggle="tab">
                    <i class="fas fa-users"></i> Borrowers
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#borrow" data-bs-toggle="tab">
                    <i class="fas fa-exchange-alt"></i> Borrow/Return
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            
            <!-- BOOKS TAB -->
            <div class="tab-pane fade show active" id="books">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Add New Book</h5>
                            </div>
                            <div class="card-body">
                                <form id="bookForm">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="bookTitle" placeholder="Title" required>
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="bookAuthor" placeholder="Author" required>
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="bookISBN" placeholder="ISBN (optional)">
                                    </div>
                                    <div class="mb-3">
                                        <input type="number" class="form-control" id="bookQuantity" placeholder="Quantity" value="1" min="1" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus"></i> Add Book
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="booksList">
                            <!-- Books will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- BORROWERS TAB -->
            <div class="tab-pane fade" id="borrowers">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Register Borrower</h5>
                            </div>
                            <div class="card-body">
                                <form id="borrowerForm">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="borrowerName" placeholder="Full Name" required>
                                    </div>
                                    <div class="mb-3">
                                        <input type="email" class="form-control" id="borrowerEmail" placeholder="Email (optional)">
                                    </div>
                                    <div class="mb-3">
                                        <input type="tel" class="form-control" id="borrowerPhone" placeholder="Phone (optional)">
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-user-plus"></i> Register
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="borrowersList">
                            <!-- Borrowers will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- BORROW/RETURN TAB -->
            <div class="tab-pane fade" id="borrow">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Borrow Book</h5>
                            </div>
                            <div class="card-body">
                                <form id="borrowForm">
                                    <div class="mb-3">
                                        <label class="form-label">Select Book</label>
                                        <select class="form-select" id="borrowBookSelect" required>
                                            <option value="">Choose a book...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Select Borrower</label>
                                        <select class="form-select" id="borrowBorrowerSelect" required>
                                            <option value="">Choose a borrower...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Due Date (optional)</label>
                                        <input type="date" class="form-control" id="borrowDueDate">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-check"></i> Confirm Borrow
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="activeBorrowsList">
                            <!-- Active borrows will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBooks();
            loadBorrowers();
            populateBorrowSelects();
        });

        // Book Form Submission
        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const isbn = document.getElementById('bookISBN').value;
            const quantity = document.getElementById('bookQuantity').value;

            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, author, isbn, quantity })
                });
                if (response.ok) {
                    showAlert('Book added successfully!', 'success');
                    document.getElementById('bookForm').reset();
                    loadBooks();
                    populateBorrowSelects();
                }
            } catch (error) {
                showAlert('Error adding book', 'danger');
            }
        });

        // Borrower Form Submission
        document.getElementById('borrowerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('borrowerName').value;
            const email = document.getElementById('borrowerEmail').value;
            const phone = document.getElementById('borrowerPhone').value;

            try {
                const response = await fetch('/api/borrowers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone })
                });
                if (response.ok) {
                    showAlert('Borrower registered successfully!', 'success');
                    document.getElementById('borrowerForm').reset();
                    loadBorrowers();
                    populateBorrowSelects();
                }
            } catch (error) {
                showAlert('Error registering borrower', 'danger');
            }
        });

        // Borrow Form Submission
        document.getElementById('borrowForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const book_id = document.getElementById('borrowBookSelect').value;
            const borrower_id = document.getElementById('borrowBorrowerSelect').value;
            const due_date = document.getElementById('borrowDueDate').value;

            try {
                const response = await fetch('/api/borrow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ book_id, borrower_id, due_date })
                });
                if (response.ok) {
                    showAlert('Book borrowed successfully!', 'success');
                    document.getElementById('borrowForm').reset();
                    loadBooks();
                    populateBorrowSelects();
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Error borrowing book', 'danger');
                }
            } catch (error) {
                showAlert('Error borrowing book', 'danger');
            }
        });

        async function loadBooks() {
            try {
                const response = await fetch('/api/books');
                const books = await response.json();
                displayBooks(books);
            } catch (error) {
                console.error('Error loading books:', error);
            }
        }

        function displayBooks(books) {
            const booksList = document.getElementById('booksList');
            if (books.length === 0) {
                booksList.innerHTML = '<div class="text-center text-muted">No books yet.</div>';
                return;
            }
            booksList.innerHTML = books.map(book => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${book.title}</h5>
                                <p class="card-text text-muted">${book.author}</p>
                                ${book.isbn ? `<small>ISBN: ${book.isbn}</small><br>` : ''}
                                <small class="text-success">Available: <strong>${book.available}/${book.quantity}</strong></small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadBorrowers() {
            try {
                const response = await fetch('/api/borrowers');
                const borrowers = await response.json();
                displayBorrowers(borrowers);
            } catch (error) {
                console.error('Error loading borrowers:', error);
            }
        }

        function displayBorrowers(borrowers) {
            const borrowersList = document.getElementById('borrowersList');
            if (borrowers.length === 0) {
                borrowersList.innerHTML = '<div class="text-center text-muted">No borrowers yet.</div>';
                return;
            }
            borrowersList.innerHTML = borrowers.map(borrower => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${borrower.name}</h5>
                                ${borrower.email ? `<p class="card-text">${borrower.email}</p>` : ''}
                                ${borrower.phone ? `<small>${borrower.phone}</small>` : ''}
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteBorrower(${borrower.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function populateBorrowSelects() {
            const [books, borrowers] = await Promise.all([
                fetch('/api/books').then(r => r.json()),
                fetch('/api/borrowers').then(r => r.json())
            ]);

            const bookSelect = document.getElementById('borrowBookSelect');
            const borrowerSelect = document.getElementById('borrowBorrowerSelect');

            bookSelect.innerHTML = '<option value="">Choose a book...</option>' +
                books.filter(b => b.available > 0).map(b => 
                    `<option value="${b.id}">${b.title} (${b.author})</option>`
                ).join('');

            borrowerSelect.innerHTML = '<option value="">Choose a borrower...</option>' +
                borrowers.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            loadActiveBorrows();
        }

        async function loadActiveBorrows() {
            const borrowerSelect = document.getElementById('borrowBorrowerSelect');
            const borrowerId = borrowerSelect.value;
            
            if (!borrowerId) {
                document.getElementById('activeBorrowsList').innerHTML = 
                    '<div class="text-center text-muted">Select a borrower to see active borrows</div>';
                return;
            }

            try {
                const response = await fetch(`/api/borrowers/${borrowerId}/active-borrows`);
                const borrows = await response.json();
                displayActiveBorrows(borrows);
            } catch (error) {
                console.error('Error loading active borrows:', error);
            }
        }

        function displayActiveBorrows(borrows) {
            const container = document.getElementById('activeBorrowsList');
            if (borrows.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">No active borrows</div>';
                return;
            }
            container.innerHTML = borrows.map(borrow => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">${borrow.title}</h5>
                                <p class="card-text text-muted">${borrow.author}</p>
                                <small>Borrowed: ${new Date(borrow.borrowed_at).toLocaleDateString()}</small><br>
                                ${borrow.due_date ? `<small>Due: ${new Date(borrow.due_date).toLocaleDateString()}</small>` : ''}
                            </div>
                            <button class="btn btn-sm btn-success" onclick="returnBook(${borrow.id})">
                                <i class="fas fa-undo"></i> Return
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function deleteBook(id) {
            if (confirm('Delete this book?')) {
                try {
                    await fetch(`/api/books/${id}`, { method: 'DELETE' });
                    showAlert('Book deleted', 'success');
                    loadBooks();
                    populateBorrowSelects();
                } catch (error) {
                    showAlert('Error deleting book', 'danger');
                }
            }
        }

        async function deleteBorrower(id) {
            if (confirm('Delete this borrower?')) {
                try {
                    await fetch(`/api/borrowers/${id}`, { method: 'DELETE' });
                    showAlert('Borrower deleted', 'success');
                    loadBorrowers();
                    populateBorrowSelects();
                } catch (error) {
                    showAlert('Error deleting borrower', 'danger');
                }
            }
        }

        async function returnBook(borrowHistoryId) {
            try {
                const response = await fetch(`/api/return/${borrowHistoryId}`, { method: 'POST' });
                if (response.ok) {
                    showAlert('Book returned successfully!', 'success');
                    loadBooks();
                    populateBorrowSelects();
                }
            } catch (error) {
                showAlert('Error returning book', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('alertContainer').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Reload active borrows when borrower changes
        document.getElementById('borrowBorrowerSelect').addEventListener('change', loadActiveBorrows);
    </script>
</body>
</html>
